$gw=((Get-NetIPConfiguration | Where-Object {$_.IPv4DefaultGateway -or $_.IPv6DefaultGateway} | Select-Object -First 1).IPv4DefaultGateway.NextHop); if(-not $gw){Write-Host "No default gateway found." -ForegroundColor Yellow; break}; $ts=Get-Date -Format "yyyyMMdd_HHmmss"; $outDir=(Test-Path 'C:\Temp')?'C:\Temp':$env:TEMP; $out="$outDir\GW_Scan_$ts.txt"; "=== Gateway Scan ($env:COMPUTERNAME) GW=$gw @ $(Get-Date -Format o) ===" | Out-File $out -Encoding UTF8; "Ping: " + ($(if(Test-Connection -Count 1 -Quiet -ErrorAction SilentlyContinue -ComputerName $gw){"Reachable"}else{"Unreachable"})) | Out-File $out -Append; $tcp=@(22,80,135,139,443,445,3389); "---- TCP ----" | Out-File $out -Append; foreach($p in $tcp){$r=Test-NetConnection -ComputerName $gw -Port $p -WarningAction SilentlyContinue; "{0,5}/tcp : {1}" -f $p,($(if($r.TcpTestSucceeded){"open"}else{"closed/filtered"})) | Out-File $out -Append}; $udp=@(161,500,4500); "---- UDP ----" | Out-File $out -Append; foreach($p in $udp){$ok=$false; try{$c=new-Object System.Net.Sockets.UdpClient; $c.Client.ReceiveTimeout=600; $c.Connect($gw,$p); $buf=[byte[]](0); [void]$c.Send($buf,0); $remote=new-object System.Net.IPEndPoint([System.Net.IPAddress]::Any,0); $resp=$c.Client.Poll(600000,[System.Net.Sockets.SelectMode]::SelectRead); if($resp -and $c.Available -gt 0){$ok=$true}; $c.Close()}catch{}; "{0,5}/udp : {1}" -f $p,($(if($ok){"responsive"}else{"no-response (open|filtered)" })) | Out-File $out -Append}; "Output: $out" | Out-File $out -Append; Write-Host "Done. Output: $out" -ForegroundColor Green
