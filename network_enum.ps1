$gw=((Get-NetIPConfiguration | Where-Object {$_.IPv4DefaultGateway -or $_.IPv6DefaultGateway} | Select-Object -First 1).IPv4DefaultGateway.NextHop); if(-not $gw){Write-Host "No default gateway found." -ForegroundColor Yellow; break}; $ts=Get-Date -Format "yyyyMMdd_HHmmss"; $outDir=$env:TEMP; if(Test-Path 'C:\Temp'){ $outDir='C:\Temp' }; $out="$outDir\GW_Scan_$ts.txt"; "=== Gateway Scan ($env:COMPUTERNAME) GW=$gw @ $(Get-Date -Format o) ===" | Out-File $out -Encoding UTF8; if(Test-Connection -Count 1 -Quiet -ErrorAction SilentlyContinue -ComputerName $gw){ "Ping: Reachable" | Out-File $out -Append } else { "Ping: Unreachable" | Out-File $out -Append }; $tcp=@(22,80,135,139,443,445,3389); "---- TCP ----" | Out-File $out -Append; foreach($p in $tcp){ $r=Test-NetConnection -ComputerName $gw -Port $p -WarningAction SilentlyContinue; if($r.TcpTestSucceeded){ ("{0,5}/tcp : open" -f $p) | Out-File $out -Append } else { ("{0,5}/tcp : closed/filtered" -f $p) | Out-File $out -Append } }; $udp=@(161,500,4500); "---- UDP ----" | Out-File $out -Append; foreach($p in $udp){ $ok=$false; try{ $c=New-Object System.Net.Sockets.UdpClient; $c.Client.ReceiveTimeout=600; $c.Connect($gw,$p); $buf=[byte[]](0); [void]$c.Send($buf,0); $resp=$c.Client.Poll(600000,[System.Net.Sockets.SelectMode]::SelectRead); if($resp -and $c.Available -gt 0){ $ok=$true }; $c.Close() } catch { }; if($ok){ ("{0,5}/udp : responsive" -f $p) | Out-File $out -Append } else { ("{0,5}/udp : no-response (open|filtered)" -f $p) | Out-File $out -Append } }; "Output: $out" | Out-File $out -Append; Write-Host "Done. Output: $out" -ForegroundColor Green
